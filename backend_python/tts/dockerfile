FROM python:3.10-slim

WORKDIR /app

# 1. On installe wget ET les d√©pendances syst√®me pour l'audio et ONNX
# Libgomp1 est souvent n√©cessaire pour onnxruntime sur Debian/Ubuntu
RUN apt-get update && apt-get install -y \
    wget \
    libgomp1 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# 2. On installe les d√©pendances Python d'abord (meilleure mise en cache)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 3. Cr√©ation de l'arborescence
RUN mkdir -p model/tts

# 4. T√©l√©chargement "intelligent"
# Si tu veux vraiment √©viter de ret√©l√©charger, on peut copier le dossier local d'abord.
# Si le dossier est vide sur ton PC, Docker ne copiera rien, et le script t√©l√©chargera.
COPY model* /app/model/

RUN if [ ! -f model/tts/kokoro-v1.0.onnx ]; then \
    echo "üì• T√©l√©chargement du mod√®le ONNX..." && \
    wget -q https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/kokoro-v1.0.onnx -O model/tts/kokoro-v1.0.onnx; \
    fi && \
    if [ ! -f model/tts/voices-v1.0.bin ]; then \
    echo "üì• T√©l√©chargement des voix..." && \
    wget -q https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/voices-v1.0.bin -O model/tts/voices-v1.0.bin; \
    fi

# 5. On finit par copier le reste du code
COPY . .

EXPOSE 8002
CMD ["python", "tts_service.py"]
